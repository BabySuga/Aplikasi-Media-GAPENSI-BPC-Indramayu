<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data Pengumuman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
    <style>
        body { font-family: "Roboto", sans-serif; }
        aside { background-color: #1f2937; width: 16rem; display: flex; flex-direction: column; color: #d1d5db; user-select: none; transition: transform 0.3s ease-in-out; transform: translateX(0); z-index: 30; position: relative; }
        aside.hidden { transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100vh; box-shadow: 4px 0 8px rgba(0, 0, 0, 0.5); }
        aside .logo-section { padding: 1.5rem 1.5rem; border-bottom: 1px solid #374151; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 0.875rem; color: white; user-select: text; }
        aside nav { display: flex; flex-direction: column; padding: 1rem 0.5rem; gap: 0.25rem; flex-grow: 1; }
        aside nav .group > button { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border-radius: 0.375rem; background: none; border: none; color: #9ca3af; cursor: pointer; }
        aside nav .group > button:hover { background-color: #111827; color: #d1d5db; }
        aside nav .group > button i.fa-chevron-down { transition: transform 0.2s; }
        aside nav .group > button[aria-expanded="true"] i.fa-chevron-down { transform: rotate(180deg); }
        aside nav .dropdown { display: flex; flex-direction: column; margin-left: 2rem; margin-top: 0.25rem; gap: 0.25rem; }
        aside nav .dropdown.hidden { display: none; }
        aside nav .dropdown a { padding: 0.25rem 1rem; border-radius: 0.375rem; color: #9ca3af; text-decoration: none; font-weight: 400; font-size: 0.875rem; }
        aside nav .dropdown a:hover { background-color: #111827; color: #d1d5db; }
        aside nav .dropdown a.selected { background-color: #111827; color: #d1d5db; font-weight: 600; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 20; }
        #sidebar-overlay.active { display: block; }
        @media (max-width: 768px) {
            aside { position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-100%); box-shadow: 4px 0 8px rgba(0, 0, 0, 0.5); }
            aside.visible { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-[#2a2a2a] text-gray-300">
    <div class="flex flex-row min-h-screen">
        <div id="sidebar-container"></div>
        <main class="flex-1 flex flex-col bg-white">
            <header class="flex items-center justify-between px-6 py-3 border-b">
                <div class="flex items-center space-x-6">
                    <button aria-label="Menu" id="menu-toggle" class="text-gray-600 text-2xl">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img alt="Gapensi Indramayu" src="src/logo_gapensi.png" style="height: 50px; width: auto;" />
                </div>
                <div>
                    <button aria-label="User profile" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i class="fas fa-user-circle text-gray-600 text-3xl"></i>
                    </button>
                </div>
            </header>
            <div class="bg-[#2c3a99] h-2"></div>
            <nav aria-label="Breadcrumb" class="px-6 py-3 text-gray-700 text-sm font-normal bg-gray-200">
                Home / Input Data Pengumuman
            </nav>
            <section class="p-6 flex-1 overflow-auto">
                <div class="bg-white rounded-lg shadow-md p-8 max-w-4xl mx-auto">
                    <form id="pengumuman-form">
                        <div class="mb-6">
                            <label for="judul" class="block text-gray-700 text-sm font-bold mb-2">Judul Pengumuman</label>
                            <input type="text" id="judul" name="judul" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                             <label class="block text-gray-700 text-sm font-bold mb-2">Foto (Image Upload)</label>
                            <div class="flex items-center space-x-4">
                                <label for="file-upload" class="cursor-pointer bg-white border border-gray-400 rounded-md py-2 px-4 text-sm text-gray-800 hover:bg-gray-50">Choose File</label>
                                <input id="file-upload" name="file-upload" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg" required>
                                <span id="file-name" class="text-gray-600 text-sm">Tidak ada file yang dipilih</span>
                            </div>
                            <p class="text-gray-500 text-xs mt-2">Maksimal 300Kb setelah kompresi. Tipe File: JPG, JPEG, PNG</p>
                        </div>
                         <div class="mb-8">
                            <label for="isi" class="block text-gray-700 text-sm font-bold mb-2">Isi Pengumuman</label>
                            <textarea id="isi" name="isi" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" required></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="tanggal" class="block text-gray-700 text-sm font-bold mb-2">Tanggal</label>
                            <input type="date" id="tanggal" name="tanggal" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <button type="submit" id="submit-button" class="bg-[#2c3a99] hover:bg-blue-800 text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline">Submit</button>
                        </div>
                    </form>
                    <div id="status-message" class="mt-4 text-center"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="sidebar-overlay"></div>
    <script src="sidebar.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pengumumanForm = document.getElementById('pengumuman-form');
            const fileUpload = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('submit-button');
            const tanggalInput = document.getElementById('tanggal');
            const judulInput = document.getElementById('judul'); // Get the judul input element
            const isiInput = document.getElementById('isi'); // Get the isi textarea element

            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            tanggalInput.value = formattedDate;

            const API_URL = "http://gapensi-dev.eba-e2qpd5r2.ap-southeast-1.elasticbeanstalk.com/add-announcement/";

            if (fileUpload && fileNameSpan) {
                fileUpload.addEventListener('change', () => {
                    if (fileUpload.files.length > 0) {
                        fileNameSpan.textContent = fileUpload.files[0].name;
                    } else {
                        fileNameSpan.textContent = 'Tidak ada file yang dipilih';
                    }
                });
            }

            // --- Function to capitalize the first letter of each word ---
            function capitalizeWords(str) {
                // Ensure str is a string before calling replace
                if (typeof str !== 'string' || str.trim() === '') {
                    return '';
                }
                return str.replace(/\b\w/g, char => char.toUpperCase());
            }

            // --- Add event listener to capitalize judul on input ---
            if (judulInput) {
                judulInput.addEventListener('input', function() {
                    this.value = capitalizeWords(this.value);
                });
            }

            // --- Function to convert new lines in textarea to HTML <br> and <p> tags ---
            function convertNewLinesToHtml(text) {
                if (typeof text !== 'string' || text.trim() === '') {
                    return '';
                }
                // Replace multiple newlines (e.g., two or more) with paragraph breaks
                // and single newlines with <br> tags.
                // First, escape HTML characters to prevent XSS and display issues.
                let escapedText = text.replace(/&/g, '&amp;')
                                      .replace(/</g, '&lt;')
                                      .replace(/>/g, '&gt;')
                                      .replace(/"/g, '&quot;')
                                      .replace(/'/g, '&#039;');

                // Replace two or more newlines with </p><p> for true paragraph breaks
                // Then replace single newlines with <br>
                let htmlFormattedText = escapedText.replace(/\n{2,}/g, '</p><p>')
                                               .replace(/\n/g, '<br>');

                // Wrap the entire content in a <p> tag if it's not already
                if (!htmlFormattedText.startsWith('<p>') || !htmlFormattedText.endsWith('</p>')) {
                    htmlFormattedText = '<p>' + htmlFormattedText + '</p>';
                }
                return htmlFormattedText;
            }


            if (pengumumanForm) {
                pengumumanForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const judul = judulInput.value;
                    let isi = isiInput.value; // Get the isi value
                    isi = convertNewLinesToHtml(isi); // Convert new lines to HTML
                    const tanggal = document.getElementById('tanggal').value;
                    const originalFile = fileUpload.files[0];

                    if (!originalFile) {
                        statusMessage.textContent = 'Harap pilih sebuah gambar.';
                        statusMessage.className = 'mt-4 text-center text-red-500';
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = 'Memproses Gambar...';
                    statusMessage.textContent = 'Sedang memproses gambar dan mengunggah data, mohon tunggu...';
                    statusMessage.className = 'mt-4 text-center text-blue-500';

                    // --- Image Processing Logic ---
                    const reader = new FileReader();
                    reader.readAsDataURL(originalFile);
                    reader.onload = function(event) {
                        const img = new Image();
                        img.src = event.target.result;

                        img.onload = function() {
                            const MAX_WIDTH = 800; // Max width for the resized image
                            const MAX_HEIGHT = 450; // Max height for the resized image
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            let quality = 0.9; // Starting quality
                            let compressedDataUrl = canvas.toDataURL(originalFile.type, quality);
                            let compressedBlob = dataURLtoBlob(compressedDataUrl);

                            while (compressedBlob.size > 300 * 1024 && quality > 0.1) {
                                quality -= 0.05; // Decrease quality
                                compressedDataUrl = canvas.toDataURL(originalFile.type, quality);
                                compressedBlob = dataURLtoBlob(compressedDataUrl);
                            }

                            if (compressedBlob.size > 300 * 1024) {
                                statusMessage.textContent = 'Gambar masih terlalu besar setelah kompresi. Mohon coba gambar lain.';
                                statusMessage.className = 'mt-4 text-center text-red-500';
                                submitButton.disabled = false;
                                submitButton.textContent = 'Submit';
                                return;
                            }

                            // Create FormData object with processed image
                            const formData = new FormData();
                            formData.append('judul', judul);
                            formData.append('isi', isi); // Use the HTML-formatted isi
                            formData.append('tanggal', tanggal);
                            formData.append('file', compressedBlob, originalFile.name);

                            // Send data to backend using fetch
                            fetch(API_URL, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => { throw new Error(err.detail || 'Terjadi kesalahan pada server'); });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Success:', data);
                                statusMessage.textContent = 'Pengumuman berhasil disimpan!';
                                statusMessage.className = 'mt-4 text-center text-green-500';
                                pengumumanForm.reset();
                                fileNameSpan.textContent = 'Tidak ada file yang dipilih';
                                tanggalInput.value = new Date().toISOString().split('T')[0];
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                                statusMessage.textContent = 'Gagal menyimpan pengumuman: ' + error.message;
                                statusMessage.className = 'mt-4 text-center text-red-500';
                            })
                            .finally(() => {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Submit';
                            });
                        };

                        img.onerror = () => {
                            statusMessage.textContent = 'Gagal memuat gambar.';
                            statusMessage.className = 'mt-4 text-center text-red-500';
                            submitButton.disabled = false;
                            submitButton.textContent = 'Submit';
                        };
                    };
                    reader.onerror = () => {
                        statusMessage.textContent = 'Gagal membaca file gambar.';
                        statusMessage.className = 'mt-4 text-center text-red-500';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit';
                    };
                });
            }

            // Helper function to convert Data URL to Blob
            function dataURLtoBlob(dataurl) {
                const arr = dataurl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            }
        });
    </script>
</body>
</html>
